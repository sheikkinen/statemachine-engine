name: "concurrent-controller"
initial_state: checking_queue
template: false  # This is a unique controller FSM - use Diagram view

# Controller FSM that spawns and manages worker FSMs
# Reads jobs from database queue and spawns a worker for each job
# Idles when queue is empty, checking again after 10 seconds

states:
  # === PROCESSING ===
  - checking_queue
  - spawning_worker
  - waiting_for_completion
  # === IDLE ===
  - idling
  # === ERROR ===
  - error_handling

transitions:
  # Check database queue for pending jobs
  - from: checking_queue
    to: spawning_worker
    event: new_job
  
  - from: checking_queue
    to: idling
    event: no_jobs
  
  # Spawn worker for job
  - from: spawning_worker
    to: waiting_for_completion
    event: worker_started
  
  - from: spawning_worker
    to: error_handling
    event: spawn_failed
  
  # Wait for worker to complete job - check status after 5 seconds
  - from: waiting_for_completion
    to: checking_queue
    event: timeout(5)
  
  # Idle when queue empty - check again after 10 seconds
  - from: idling
    to: checking_queue
    event: timeout(10)
  
  # Error recovery - retry immediately
  - from: error_handling
    to: checking_queue
    event: retry

# Events that can be triggered
events:
  - new_job
  - no_jobs
  - worker_started
  - spawn_failed
  - retry
  - timeout(5)
  - timeout(10)

# Actions organized by state
actions:
  checking_queue:
    - type: log
      message: "üîç Checking queue for pending patient_records jobs..."
      level: info
    
    - type: check_database_queue
      status: pending
      limit: 1
      machine_type: patient_records
      job_type: patient_records

  spawning_worker:
    - type: log
      message: "üöÄ Spawning worker for job: {current_job.id}"
      level: info
    
    - type: start_fsm
      yaml_path: "examples/patient_records/config/patient-records.yaml"
      machine_name: "patient_record_{current_job.id}"
      context_vars:
        - current_job.id as job_id      # Extract job ID from nested structure
        - report_id                      # Pass flattened job data
        - report_title                   # Pass flattened job data
        - summary_text                   # Pass flattened job data
      success: worker_started
      error: spawn_failed
      store_pid: true
    
    - type: log
      message: "‚úÖ Worker spawned: patient_record_{current_job.id}"
      level: success

  waiting_for_completion:
    - type: log
      message: "‚è≥ Waiting for worker to complete job: {current_job.id} (checking in 5s)"
      level: info

  idling:
    - type: log
      message: "üò¥ Queue empty - waiting 10 seconds before next check..."
      level: info

  error_handling:
    - type: log
      message: "‚ùå Failed to spawn worker for job: {current_job.id}"
      level: error
    
    - type: bash
      command: "echo 'Spawn error - retrying...'"
      success: retry
