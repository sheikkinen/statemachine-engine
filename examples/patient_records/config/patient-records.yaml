name: "patient-records"
initial_state: summarizing  # Auto-start processing when spawned
template: true  # This is a templated worker FSM - use Kanban view

# Define states with composite groupings for diagram visualization
states:
  # === SUMMARIZING ===
  - summarizing
  # === FACT_CHECKING ===
  - fact_checking
  # === COMPLETED ===
  - ready  
  - failed
  - shutdown

transitions:
  # Convert report into paragraph summary (auto-completes after 10s)
  - from: summarizing
    to: fact_checking
    event: timeout(30)
  
  # Manual completion (if needed before timeout)
  - from: summarizing
    to: fact_checking
    event: summary_complete

  # Validation loop - summary not based on report, try again
  - from: summarizing
    to: summarizing
    event: summary_invalid

  # Check that summary is based on report (auto-validates after 5s)
  - from: fact_checking  
    to: ready
    event: timeout(30)
  
  # Manual validation (if needed before timeout)
  - from: fact_checking  
    to: ready
    event: validation_passed

  # Validation loop - facts don't match, go back to summarizing
  - from: fact_checking
    to: summarizing
    event: validation_failed

  # Handle processing failures
  - from: summarizing
    to: failed
    event: processing_error

  - from: fact_checking
    to: failed
    event: processing_error

  # Reset failed reports for retry
  - from: failed
    to: summarizing
    event: retry_report

  # Process another report from ready state
  - from: ready
    to: summarizing
    event: process_next

  # Stop from anywhere for graceful shutdown
  - from: "*"
    to: shutdown
    event: stop

# Events that can be triggered externally
events:
  - summary_complete
  - summary_invalid
  - validation_passed
  - validation_failed
  - processing_error
  - retry_report
  - process_next
  - job_completed
  - completion_failed
  - stop

# Actions organized by state (executed when entering that state)
actions:
  summarizing:
    - type: log
      message: "üîç Context verification - Job ID: {job_id}, Report: {report_id} ({report_title})"
      level: info
    - type: log
      message: "üìÑ Starting to process report {report_id}: {report_title}"
      level: info
    - type: log
      message: "‚úçÔ∏è Generating summary (auto-completes in 30s)..."
      level: info

  fact_checking:
    - type: log
      message: "üîç Fact-checking summary for report {report_id}"
      level: info
    - type: log
      message: "‚úÖ Validating facts (auto-completes in 30s)..."
      level: info

  ready:
    - type: log
      message: "‚úÖ Report {report_id} validation passed - ready for history generation"
      level: success
    
    - type: complete_job
      job_id: "{job_id}"
      success: job_completed
      error: completion_failed
    
    - type: bash
      command: "echo 'Report {report_id} complete - triggering shutdown'"
      timeout: 5
      success: stop

  failed:
    - type: log
      message: "üí• Processing error for report {report_id}: {error_message}"
      level: error

  shutdown:
    - type: log
      message: "üëã Patient record processor shutting down..."
      level: info
